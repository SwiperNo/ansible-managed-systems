name: Advanced patch management with revert step
hosts: all
gather_facts: false


tasks:
  name: Take vmware snapshot
  vmware_guest_snapshot:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: no
    datacenter: "{{ datacenter_name }}"
    name: "{{ inventory_hostname }}"
    state: present
    delegate_to: localhost
register: snapshot_result

  name: Create list of servers with successful snapshot
  set_fact:
    servers_successful_snapshot: "{{ servers_successful_snapshot | default([]) + [inventory_hostname] }}"
    when: snapshot_result.changed
    
  name: Create list of servers that failed snapshot
  set_fact:
    servers_failed_snapshot: "{{ servers_failed_snapshot | default([]) + [inventory_hostname] }}"
    when: snapshot_result.failed
    
  name: Yum update servers with successful snapshot
  yum:
    name: "*"
    state: latest
  when: inventory_hostname in servers_successful_snapshot
  register: update_result
  
  name: Create list of servers that updated successfully
  set_fact:
    servers_successful_update: "{{ servers_successful_update | default([]) + [inventory_hostname] }}"
  when: update_result.changed
  
  name: Create list of servers that failed update
  set_fact:
    servers_failed_update: "{{ servers_failed_update | default([]) + [inventory_hostname] }}"
  when: update_result.failed
  
  name: Revert server from snapshot if update fails
  vmware_guest_snapshot:
    hostname: "{{ vcenter_hostname }}"
    username: "{{ vcenter_username }}"
    password: "{{ vcenter_password }}"
    validate_certs: no
    datacenter: "{{ datacenter_name }}"
    name: "{{ inventory_hostname }}"
    state: revert
  delegate_to: localhost
  when: update_result.failed
  
  
  name: Send email with snapshot and update results
  mail:
    host: "{{ mail_server }}"
    port: "{{ mail_port }}"
    username: "{{ mail_username }}"
    password: "{{ mail_password }}"
    to: "{{ mail_to }}"
    subject: "Snapshot and update results"
    body: |
      Here is a summary of the snapshot and update results:
      Servers with successful snapshot: {{ servers_successful_snapshot | join(', ') }}
      Servers that failed snapshot: {{ servers_failed_snapshot | join(', ') }}
      Servers that updated successfully: {{ servers_successful_update | join(', ') }}
      Servers that failed update: {{ servers_failed_update | join(', ') }}
      Servers that were reverted and failed update: {{ servers_failed_update | intersect(servers_successful_snapshot) | join(', ') }}
  delegate_to: localhost
